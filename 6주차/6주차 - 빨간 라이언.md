# 11장
# 뉴스 피드 시스템 설계

## 피드 발행 흐름 상세 설계

### 웹 서버

- 클라이언트와 통신 뿐만 아니라 인증, 처리율 제한등의 기능도 수행, 올바른 인증토큰을 헤더에 담고 API를 호출하는 사용자만 포스팅 가능해야함, 또한 스팸, 유해한 콘텐츠가 자주 올라오는 것을 방지하기 위해서 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅의 수에 제한을 두어야 한다.

### 포스팅 전송(팬아웃)  서비스

- 팬아웃은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정, 팬 아웃에는 2가지 모델이 있는데 하나는 쓰기 시점에 팬아웃 하는 모델이고 하나는 읽기 시점에 팬아웃 하는 모델이다.
1. 쓰기 시점에 팬아웃 하는 모델 : 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신, 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록하는 것이다.
2. 읽기 시점에 팬아웃 하는 모델 : 피드를 읽어야 하는 시점에 뉴스 피드를 갱신한다. 사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져오게 된다.

### 쓰기, 읽기 시점에 팬아웃 동작 흐름

1. 그래프 DB에서 친구 ID 목록을 가져온다.
2. 사용자 정보 캐시에서 친구들의 정보를 가져온다. 이후에 사용자 설정에 따라 친구 가운데 일부를 걸러낸다.
3. 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
4. 팬아웃 작업 서버는 메시지 큐에서 데이터를 꺼내서 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다. 해당 데이터는 <post_id, user_id> 방식으로 되어있다.
5. 뉴스 피드에 표시할 사용자 이름, 사용자 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 ㅍ포스팅 캐시에서 가져와 완전한 뉴스 피드를 만든다.
6. 생성된 뉴스 피드를 JSON 형태로 클라이언트에게 보낸다.

### 캐시 구조

- 뉴스 피드 : 뉴스 피드의 ID를 보관한다.
- 콘텐츠 : 포스팅 데이터를 보관한다. 인기 콘텐츠는 따로 보관한다.
- 소셜 그래프 : 사용자 간 관계 정보를 보관한다.
- 행동 : 포스팅에 대한 사용자의 행위에 관한 정보를 보관한다. 포스팅에 대한 ‘좋아요’, ‘답글’ 등등이 이에 해당한다.
- 횟수 : 좋아요 횟수, 응답 수, 팔로어 수, 팔로잉 수 등의 정보를 보관한다.

### 추가적으로 다루면 좋은 내용

- DB 확장
    - 스케일 업 vs 스케일 아웃
    - SQL vs NoSQL
    - master-salve 다중화
    - 복제본 에 대한 읽기 연산
    - 일관성 모델
    - DB 샤딩

--------

# 12장
