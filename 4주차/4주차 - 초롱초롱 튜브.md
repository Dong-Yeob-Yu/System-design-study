# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

데이터베이스 서버가 여러 대인 분산 시스템에서 유일성이 보장되는 ID를 생성하는 방법들을 살펴보자.

이번 장에서 ID가 만족시켜야 하는 특성은 다음과 같다고 가정하자.

> ID는 유일해야 한다.
> 
> ID는 숫자로만 구성되어야 한다.
> 
> ID는 64비트로 표현될 수 있는 값이어야 한다.
> 
> ID는 발급 날짜에 따라 정렬 가능해야 한다.
> 
> 초당 10,000개의 ID를 만들 수 있어야 한다.

## 다중 마스터 복제 (multi-master replication)

데이터베이스의 **auto_increment**를 활용하는 방법인데, 다음 ID를 구할 때 1이 아닌 **k만큼 증가**시킨다는 점이 다르다. 여기서 k는 현재 사용 중인 데이터베이스 서버의 개수이다.

장점

- 데이터베이스 서버 개수를 늘리면 초당 생산 가능 ID 수도 늘릴 수 있어, 규모 확장성 문제를 어느 정도 해결할 수 있다.

단점

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
  
- ID의 유일성은 보장되지만 ID 값이 시간이 흐름에 따라 커지는 것을 보장할 수는 없다.
  
- 서버를 추가 또는 삭제할 때에도 잘 동작하게 만들기 어렵다.

## UUID (University Unique Identifier)

UUID란 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트짜리 수로, **UUID 값은 충돌 가능성이 매우 낮다**.

장점

- UUID는 서버 간의 조율 없이 **독립적으로** 생성 가능하므로 단순하고 동기화 이슈가 없다.
  
- 각 서버가 자기가 사용할 ID를 각자 생성하는 구조이므로 규모 확장 또한 쉽다.

단점

- 128비트로 굉장히 길며, 숫자가 아닌 값이 포함될 수도 있다.
  
- 시간순으로 정렬할 수 없다는 점이 ID로 사용하기에 부적합할 수 있다.

## 티켓 서버 (ticket server)

auto_increment를 갖춘 데이터베이스 서버, 즉 **티켓 서버**를 **중앙 집중형**으로 하나만 사용하는 방법이다.

분산 기본 키(distributed primary key)를 만들기 위해 티켓 서버를 활용할 수 있다.

장점

- 유일성이 보장되는, 오직 숫자로만 구성된 ID를 쉽게 만들 수 있다.
  
- 구현이 쉬우며, 중소 규모 애플리케이션에 적합하다.

단점

- 티켓 서버가 **SPOF**가 된다. 이를 피하기 위해서는 여러 대의 티켓 서버가 필요한데, 이에 따라 동기화와 같은 새로운 문제가 발생한다.

## 트위터 스노플레이크(twitter snowflake) 접근법

트위터에서 고안한 방법으로, 분할 정복 전략(divide and conquer)을 적용하여 생성해야 하는 ID의 구조를 **여러 section으로 분할**하는 방법이다.

이를 사용하면 모든 요구사항을 만족시키면서 규모 확장이 가능하다.

![image](https://github.com/user-attachments/assets/db093eea-1bd0-4e4b-9f14-ef697fec0176)

- 타임스탬프(timestamp) : 41비트를 차지하며, epoch time 이후로 경과한 밀리초를 나타낸다.
  
- 데이터센터 및 서버 ID (instance)
  
- 일련번호(sequence) : 12비트를 차지하며, 각 서버에서 ID 생성 시 이 일련번호를 1씩 증가시키고 1밀리초가 경과할 때마다 0으로 초기화된다.

데이터센터 및 서버 ID는 시스템이 시작할 때 결정되어 일반적으로 운영 중에는 변하지 않는다. 반면 타임스탬프나 일련번호는 ID 생성기가 실행 중에 동적으로 생성되는 값이다.

### 타임스탬프

시간이 흐름에 따라 타임스탬프는 점점 커지므로, 결국 ID는 **시간 순으로 정렬 가능**하게 된다.

위의 ID 구조에서 timestamp를 나타내는 41비트를 십진수로 변환 후 epoch time을 더함으로써 UTC 시각을 추출할 수 있다. 

41비트로 표현할 수 있는 타임스탬프의 최댓값에 따라 해당 ID 생성기는 **69년 동안 정상 동작**한다. 따라서 69년이 지나면 기원 시각을 바꾸거나 ID 체계를 이전(migration)해야 한다.

### 일련번호

일련번호는 12비트이므로, $2^{12}$(4096)개의 값을 가질 수 있다. 특정 서버가 1 밀리초 이내에 하나 이상의 ID를 생성한 경우에 한해 0보다 큰 값을 갖는다.

### 추가 논의 사항

- 시계 동기화(clock synchronization) : 하나의 서버가 여러 코어에서 실행되거나 물리적으로 독립된 장비에서 실행되는 경우, ID 생성 서버들이 각각 다른 clock을 사용할 것이다. 보편적으로 NTP(Network Time Protocol)로 이를 해결할 수 있다.
  
- 각 section의 길이 최적화 : 애플리케이션의 동시성 정도, 수명 등에 따라 일련번호 및 타임스탬프 section의 길이를 조절하여 최적화할 수 있다.

- 고가용성(high availability) : 필수적인 컴포넌트로 아주 높은 가용성이 필요하다.
