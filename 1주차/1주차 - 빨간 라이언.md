# 1장 

# 단일서버

- 하나의 서버에서 웹, DB, 캐시가 전부 실행

기본적인 웹 동작 방식 :

1.  DNS로 요청을 한다.
2. DNS 서비스는 IP주소를 반환한다.
3. 반환된 IP주소를 이용해 HTTP 요청을 한다.
4. 요청받은 웹 서버는 HTML, JSON, XML 등을 응답한다.

## 데이터베이스

- 사용자가 늘어나면 서버 한대로는 적절한 처리를 하기에 충분하지 않다. 이때 서버를 여러대 두는데 먼저 데이터 베이스 서버용이다.
- 웹 계층과 DB 계층으로 분리하면 각각을 독립적으로 확장할 수 있다.

### 어떤 DB를 사용할 것인가?

DB는 크게 관계형 데이터베이스 (RDB), 비 관계형 데이터베이스 (NoSQL)이 있다.

- RDB는 열, 컬럼으로 표현하며 테이블을 관계에 따라 합치는 JOIN 연산을 할 수 있다.
- NoSQL 은 RDB와 다르게 JOIN 연산 자체는 지원하지않지만 특정 조건에 따라 RDB보다 더 효율적인 접근이 될 수 있다.

특정 조건 :

1. 매우 낮은 응답 지연시간(Low Latency)
2. 다루는 데이터가 비정형, 관계형 데이터 X
3. 데이터를 직렬화, 역직렬화만 가능하면 됨
4. 아주 많은 양의 데이터를 저장

## 수직적 규모 확장 vs 수평적 규모 확장

수직적 규모 확장 (scale up) 은 서버에 고사양 자원(좋은 CPU, 많은 RAM)을 더욱 추가하는 방식이며

수평적 규모 확장 (scale out) 은 서버를 여러대 추가하는 행위를 말한다.

수직적 규모 확장은 한계가 있으며 (무한대로 서버 자원 증가 X, 서버에 장애가 발생하면 서버는 완전히 내려감) 대부분의 대규모 서비스에선 수평적 규모 확장을 이용한다.

## 로드밸런서

로드밸런서는 부하 분산 집합이며 트래픽 부하를 고르게 분산하는 역할을 한다. 웹 서버는 클라이언트 접속을 직접 처리하지 않는다.

1. 서버 1이 다운되면 모든 트래픽은 서버 2로 전송되며, 하나의 서버에 장애가 발생해도 서비스가 멈추지 않는다.
2. 트래픽이 더 늘어나는시점이면 서버 3을 추가해서 유연하게 대처할수있다.

## DB 다중화

대부분의 RDB는 DB의 다중화를 지원한다. master와 slave 관계를 설정하고 주 데이터는 master에 사본은 slave 에 저장한다. 쓰기 연산은 마스터에서만 지원하며 슬레이브는 읽기 연산만 가능하다.

보통의 서비스는 쓰기(Write) 연산보다 읽기(Read) 연산이 더 비중이 높다.

이럴때 쓰기와 읽기 서버를 분산하고 데이터를 작성할땐 마스터서버, 읽기를 할땐 슬레이브서버에 접근하면 효율적으로 인덱스 설정이 가능하며 성능상 이점이 발생한다.

하지만 읽기와 쓰기 서버 2개만 사용할때 하나의 서버가 다운되면 문제가 발생할텐데, 이러한 상황엔 읽기와 쓰기 모두 하나의 서버에 전달되고 새로운 서버가 다운된 서버의 자리를 대신한다.

만약 쓰기 서버가 다운되었을땐 데이터가 최신상태가 아닐 수 있는데 이럴땐 다중 마스터, 원형 다중화등의 방식을 도입하면 이런 상황에 대처하는데 도움이 될 수 있다.

## 캐시

애플리케이션의 주요 성능 이슈중 하나는 DB 연산, 네트워크 호출 횟수 등이 있다.

이러한 이슈를 완화할 방법중 하나는 ‘캐시’이다. 캐시는 데이터를 메모리에 두고 보다 빠르게 처리 할 수 있도록 하는 저장소 이다.

캐시를 사용하면 요청이 들어왔을때 DB 요청하기 전 메모리에서 바로 가져다 쓸 수 있으므로 일반적인 상황에선 매우 효과적인 성능 이점이 존재한다.

### 캐시 사용시 유의할점

- 캐시는 데이터 갱신은 자주 일어나지않고, 참조는 빈번하게 일어나는 상황이 바람직하다.
- 캐시는 휘발성 데이터이므로 영속적으로 보관할 데이터를 캐시 저장소에 두는건 옳지않다.
- 캐시에 보관된 데이터는 만료 정책을 두는것은 올바른 습관이다. (너무 짧으면 DB 서버에 자주 접근해야 하니 성능상 이점이 줄어듬, 너무 길면 데이터 정합성의 문제 발생)
- 장애 대처에 대해 고민해보자, 하나의 캐시서버만 뒀을때 해당 서버에 장애가 발생하면 전체 시스템이 죽을 수 있다.(SPOF 단일 장애 지점)
- 캐시 메모리의 크기를 고려한다
- 데이터 방출 정책을 정한다. LRU(마지막으로 사용된 시점이 가장 오래된 데이터를 방출), LFU(사용된 빈도가 가장 낮은 데이터를 방출), FIFO(선입선출)

## CDN(콘텐츠 전송 네트워크)

이미지, 비디오, JS, CSS 등 정적 콘텐츠를 물리적으로 가까운 위치에  해당하는 CDN 서버가 정적 콘텐츠를 전달하게 된다.

CDN 서버에 정적 콘텐츠가 없으면 CDN이 직접 원본 서버에 요청한다.

### 고려사항

- 비용 : 보통 제 3 사업자에 의해 운영되며 데이터 전송 양에 따라 요금이 정해진다. 만약 자주 사용하지 않는다면 CDN 서버에 캐시하는것은 비효율적으므로 CDN에서 뺴는것이 좋다.
- 캐시와 똑같이 적절한 만료시간이 설정되어야한다.
- CDN 서버가 장애났을시 해당 문제를 감지하여 원본 서버로부터 직접 콘텐츠를 가져오도록 구성하는것이 좋다.

## 무상태 웹 계층

웹 계층을 수평적으로 확장할때 먼저 고민해 볼 사항은 사용자 세션 데이터같은 상태 정보를 웹 계층에서 제거하는것이다.

바람직한 전략은 상태정보를 RDB나 NoSQL에 저장해놓고 필요할때 가져오는것이다. 이렇게 구성된 웹 계층을 무상태 웹 계층이라고 부른다.

만약 상태 정보를 보관하는 서버는 서버가 여러대인 상태에서 다른 서버로 요청을 보낸다면 상태가 없어서 해당 요청은 실패할것이다. 이는 무조건 동일한 서버에만 데이터를 요청해야하는것인데 로드밸런서에 고정 세션이라는 기능이 있지만 해당 기능은 로드밸런서에 부담을 준다.

반면 무상태 웹 계층은 각 서버가 상태를 가지고 있지 않기에 어떤 서버로 요청을 보내든 동일한 처리가 가능하다. 이는 단순하고 안정적이며 규모 확장에 용이하다.

## 데이터 센터

두개의 데이터센터를 이용해 평소엔 가장 가까운 데이터 센터를 이용하다(지리적 라우팅) 서버에 장애가 발생했을때 모든 트래픽은 장애가 없는 데이터 센터로 전송된다.

이와 같은 다중 데이터센터 아키텍처를 만들려면 기술적 난제 몇가지를 해결해야한다.

- 트래픽 우회 : 올바른 데이터센터로 트래픽을 보내는 효괒거인 방법을 찾아야한다.
- 데이터 동기화 : 데이터 센터마다 별도의 DB 를 사용하고 있는 상황이라면 장애가 복귀된다고 하더라도 다른 데이터 센터엔 데이터가 없을 수 있다.

## 메세지 큐

메세지 큐는 메시지의 무손실(소비 하기 전까지 안전히 보관되는 특성)을 보장하는 비동기 통신 컴포넌트다.

메세지 큐 아키텍쳐 : 생산자가 메시지를 발행하고 소비자는 MQ에서 메시지를 꺼내 소비를 할 수 있다.

메세지큐의 장점으론 서비스, 서버간 결합이 느슨해져서 규모 확장성이 보장되어야하는 어플리케이션을 구성하기 좋다. 생산자와 소비자는 결합이 느슨해 서로의 프로세스가 다운되어 있어도 메시지를 발행할 수 있고, 소비할 수 있다. 작업이 오래 걸리고 비동기 처리가 가능한 작업에 적용하면 독립적으로 확장할 수 있고 처리 시간도 줄일 수 있다.

## 로그, 메트릭 그리고 자동화

로그 : 서버가 커질때 모니터링작업은 필수다. 시스템에 오류나 문제가 발생할때 가장 큰 단서가 되는 것들이다.

메트릭 : 시스템의 현재 상태를 손쉽게 파악 가능하다, 특히 호스트단위 메트릭(CPU, RAM, 디스크 I/O), 종합 메트릭(DB 성능, 캐시 성능), 핵심 비즈니스 메트릭(DAU, 수익, 재방문) 등이 있다.

자동화 : 자동화 도구를 잘 사용하면 생산성이 크게 상승된다. 빌드, 테스트, 배포등의 절차를 자동화하는것은 크고 복잡한 시스템에선 필수와도 같다.

## 샤딩

데이터베이스를 작은 단위로 분할하는 기술이다. 모든 샤드는 같은 스키마를 쓰지만 중복된 데이터는 없다.

### 샤딩의 문제점 :

- 데이터의 재 샤딩 : 하나의 샤드로는 감당이  힘들때, 샤드간 데이터 분포가 균등하지 못할때 (해당 상황은 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치)
- 유명인사 문제 : 핫스팟 키 문제라고도 부르며 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제다. 유명 인사가 전부 같은 샤드에 저장되어 있고 해당 데이터로 SNS 서비스를 만들때 해당 샤드는 read 연산때문에 과부하가 걸릴 것이다.
- 조인, 비정규화 : 하나의 데이터베이스를 여러 샤드로 쪼개면 데이터를 조인하기가 힘들어진다. 해결하는 방법은 데이터베이스를 비정규화 하여 테이블에서 질의가 수행될 수 있도록 하는 것이다.

----

# 2장 

# 개략적인 규모 추정

- 2의 제곱수 : 분산 시스템에서 다루는 데이터양은 엄청나게 커질 수 있으나 계산법은 틀을 벗어나지않는다.

| 2의 X 제곱 | 근사치 | 이름 | 축약형 |
| --- | --- | --- | --- |
| 10 | 1,000 | 1킬로바이트 | 1KB |
| 20 | 1,000,000 | 1메가바이트 | 1MB |
| 30 | 1,000,000,000 | 1기가바이트 | 1GB |
| 40 | 1조 | 1테라바이트 | 1TB |
| 50 | 1000조 | 1페타바이트 | 1PB |

# 모든 프로그래머가 알아야 하는 응답지연 값

- 메모리는 빠르지만 디스크는 아직 느리다.
- 디스크 탐색은 가능한 피하라
- 단순한 압축 알고리즘은 빠르다.
- 데이터를 인터넷으로 전송하기 전에 압축 권장
- 데이터 센터는 보통 여러곳에 분산되어있고 센터들 간에 데이터를 주고받는 데엔 시간이 걸린다.

# 고가용성

고가용성은 서비스가 중단없이 지속적으로 운영될 수 있는 능력을 지칭하는 용어다.

고가용성은 %(percent) 로 표현하는데 100%는 시스템이 단 한 번도 중단된 적이 없었음을 의미한다. 대부분의 서비스는 99% ~ 100% 사이의 값을 갖는다.

# QPS와 저장소 요구량 추정

가정 :

- MAU 는 3억명
- 50%사용자는 매일 해당  서비스를 사용
- 평균적으로 각 사용자는 2건을 포스트
- 미디어를 포함하는 글은 10%
- 데이터는 5년간 지속

계산 :

- QPS 추정치
    - DAU 는 3억 * 50% → 1.5억
    - QPS = 1.5억 * 2 / 24시간 / 3600초 = 약 3500
    - 최대 QPS = 3500 * 2건 ⇒ 7000
- 미디어 저장소 요구량 추정
    - Id - 64바이트
    - 텍스트 - 140바이트
    - 미디어 - 1MB
- 미디어 저장소 요구량 : 1.5억 * 2 * 10% * 1MB = 30TB / 일
- 5년간 미디어를 보관하기 위한 저장소 요구량 = 30TB * 365일 * 5년 ⇒ 약 55TB