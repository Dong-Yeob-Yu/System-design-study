# 1장. 사용자 수에 따른 규모 확장성

## 전체적인 통신 흐름

![](https://velog.velcdn.com/images/yeoni_/post/cfa9a185-d4d7-475b-864b-42df9f605ef9/image.png)


## 수직적 규모 확장

스케일 업(scale up)이라고도 한다. 단순히 서버의 자원을 성능을 향상시키는 것이다. 이는 서버로 유입되는 트래픽 양이 적을 때 좋은 선택이며, 단순하다는 단점이 있다. 하지만 한 대의 서버 성능을 무한대로 향상시킬 수는 없기 때문에 한계는 존재하며 서버의 개수는 여전히 고정되어 있기 때문에 장애에 대한 자동복구(fail-over) 방안이나 다중화(redundancy) 방안을 제시하지 않는다. 이렇게 단일 서버에 장애가 발생하면 서비스는 완전히 중단되며 이 문제를 SPOF 문제라고 한다. 이러한 문제 때문에 대규모 서비스는 수평적 규모 확장이 적절하다,

## 수평적 규모 확장

스케일 아웃(scale out)이라고도 하며 더 많은 서버를 추가하여 성능을 개선하는 행위를 말한다.

### 무상태 웹 계층

웹 계층을 쉽게 수평적으로 확장하기 위해서는 웹 계층을 상태 정보를 제거해야 한다. 상태 정보를 지속성 공유 저장소에 보관하고 웹 계층은 무상태를 유지하여 사용자의 HTTP 요청이 어떤 웹 서버로 전달되어도 문제가 생기지 않도록 해야 한다.

### 로드 밸런서

![](https://velog.velcdn.com/images/yeoni_/post/895e03f1-045c-4e2f-8ae2-099c8c0b8915/image.png)


부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다.

사용자는 로드 밸런서의 공개 IP 주소로 접속하고 서버 간의 통신에는 사설 IP 주소가 사용된다.
사설 IP 주소는 같은 네트워크에 속한 서버 사이의 통신에만 사용되는 IP 주소로 인터넷을 통해서는 접속할 수 없다. 로드 밸런서는 웹 서버와 통신하기 위해 바로 이 사설 주소를 이용한다.

이처럼 또 하나의 웹 서버를 추가하고 나면 자동복구 문제는 해소되며 웹 계층의 가용성은 향상된다.

→ 서버 1이 다운되면 로드밸런서에 의해 모든 트래픽은 서버 2로 처리된다. 이처럼 로드 밸런스는 자동으로 트래픽을 분산해준다. (이것을 자동복구, failover라고 한다.)

### 데이터베이스 다중화

데이터베이스 계층의 다중화 방식이란, 주로 서버 사이에 master - slave 관계를 설정하고 데이터 원본은 주 서버에 사본은 부 서버에 저장하는 방식이다. 이때 쓰기 연산은 마스터에서만 지원하며 부 데이터베이스는 그저 주 데이터베이스로부터 사본을 전달받으며 읽기 연산만을 지원한다. 데이터베이스 다중화 모델에서는 읽기 연산의 경우, 부 데이터베이스 서버들로 분산되기 때문에 병렬로 처리될 수 있는 질의 수가 늘어나므로 성능이 좋아진다.

## 캐시

캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소이다. 캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터베이스보다 훨씬 빠르다. 때문에 별도의 캐시 계층을 두면 성능이 개선될 뿐만 아니라 데이터베이스의 부하도 줄일 수 있고, 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능해진다. 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어난다면 캐시 사용을 고려해보자.

### 캐시 방출 정책

캐시가 꽉 차버린 상태에서 추가로 캐시에 데이터를 넣어야 경우, 기존 데이터를 내보내야 한다. 이것을 캐시 데이터 방출 정책이라 하는데, 그 가운데 가장 널리 쓰이는 것은 LRU(마지막으로 사용된 시점이 가장 오래된 데이터를 내보냄) 정책이다. 다른 정책들도 존재하며 이는 CPU 스케쥴링 정책들과 유사하다.

### CDN (콘텐츠 전송 네트워크)

CDN은 정적 콘텐츠를 전송하는데 쓰이는, 지리적으로 분산된 서버의 네트워크이다. 

### 동작 방식

![](https://velog.velcdn.com/images/yeoni_/post/6e4863aa-5644-4b0a-b40d-bb09079e2245/image.png)


정적 컨텐츠는 더이상 웹 서버를 통해 서비스하지 않으며 CDN을 통해 제공하여 데이터베이스의 부하를 줄여준다.

## 메시지 큐
![](https://velog.velcdn.com/images/yeoni_/post/a70c6c8c-5c89-4173-a138-aae93956ba64/image.png)

메세지 큐는 메세지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트다. 메세지의 버퍼 역할을 하며 비동기적으로 전송한다.

### 기본 아키텍쳐
생산자 또는 발행자(Producer)라고 불리는 입력 서비스가 메세지를 만들어 메세지 큐에 발행(publish)한다. 큐에는 소비자 혹은 구독자(Consumer)라 불리는 서비스 혹은 서버가 연결되어 있는데, 메세지를 받아 그에 맞는 동작을 수행하는 역할을 한다. 메세지 큐를 이용하면 서비스 또는 서버 간 결합이 느슨해져 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.

## 데이터베이스의 규모 확장

저장할 데이터가 많아지면 데이터베이스에 대한 부하도 증가한다. 때문에 데이터베이스를 증설할 방법을 찾아야 하는데 2가지 접근법이 존재한다.

### 수직적 확장

위에서 언급한 서버의 수직적 확장법과 유사하다.

### 수평적 확장

데이터베이스의 수평적 확장은 **샤딩(Sharding)**이라고도 부르는데, 더 많은 서버를 추가함으로써 성능을 향상시킬 수 있도록 한다. 샤딩은 대규모의 데이터베이스를 샤드라고 부르는 작은 단위로 분할하는 기술을 말한다. 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다. 샤딩 전략을 구현할 때 고려해야 할 가장 중요한 것은 ‘샤딩 키를 어떻게 정하느냐’ 이다. 샤딩 키는 데이터를 어떻게 분산할지 정하는 하나 이상의 칼럼으로 구성된다. 하지만 샤딩에도 유명인사 문제(핫스팟 키 문제 - 특정 샤드에 질의가 집중), 조인 연산의 어려움, 데이터의 재 샤딩 등의 여러 문제가 존재한다.