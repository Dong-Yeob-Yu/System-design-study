# 1장. 사용자 규모에 따른 규모 확장성

## 사용자 요청 처리 흐름

1. 사용자는 DNS 질의를 통해 도메인 이름에 해당하는 IP 주소를 얻어와 웹사이트에 접속한다.
2. 해당 IP 주소로 HTTP 요청이 전달된다.
3. 요청을 받은 웹 서버는 HTML이나 JSON 형태의 응답을 반환한다.

## 단일 서버의 한계

단일 서버 시스템에서는 웹 앱, 데이터베이스, 캐시 등이 한 대의 서버에서 실행된다. 그러나 사용자가 늘면 서버 하나로는 충분하지 않다.

이에 대응하기 위해 웹/모바일 트래픽 처리 서버(**웹 계층**)와 데이터베이스 서버(**데이터 계층**)를 분리하여, 각각을 독립적으로 확장할 수 있게 해야 한다.

### 데이터베이스의 종류

관계형 데이터베이스 (RDBMS) : 여러 테이블의 데이터를 관계에 따라 join할 수 있다.

비 관계형 데이터베이스 (NoSQL) : 일반적으로 join 연산 지원하지 않는다.

대부분 관계형 데이터베이스가 적합하지만, 특정 경우에는 비 관계형 데이터베이스가 적합할 수 있다.

- 응답 지연시간(latency)이 아주 낮아야 할 때
- 다루는 데이터가 비정형일 때
- 데이터를 직렬화/역직렬화하기만 할 때
- 아주 많은 양의 데이터를 저장해야 할 때

## 서버의 규모 확장

### 수직적 규모 확장

서버에 고사양 자원(CPU, RAM 등)을 추가함으로써 서버의 성능을 향상시키는 것 (스케일 업)

서버로 유입되는 트래픽이 많아지면 하드웨어 상의 한계 및 장애에 대한 failover 및 다중화 방안의 부재 등의 문제가 발생한다.

→ **대규모 트래픽**이 발생할 때에는 **수평적 규모 확장**이 적절하다.

### 수평적 규모 확장

서버를 추가함으로써 서버의 성능을 개선하는 것 (스케일 아웃)

### 로드밸런서

대규모 트래픽으로 인해 서버에 장애가 생기는 문제를 웹 계층에서 해결할 수 있다.

사용자가 로드밸런서의 공개 IP 주소로 접속하면, 로드밸런서가 **부하 분산 집합(load balancing set)**에 속한 웹 서버들에게 **트래픽 부하를 고르게 분산**하는 역할을 한다. 보안을 위해 로드밸런서와 웹 서버 간의 통신에서는 사설 IP 주소를 사용한다.

장점

- 장애에 대한 자동복구(failover) 가능
- 웹 계층의 가용성 향상

### 데이터베이스 다중화

대규모 트래픽으로 인해 서버에 장애가 생기는 문제를 데이터 계층에서 해결할 수 있다.

일반적으로 데이터베이스 다중화는 데이터베이스 서버 사이에 **주(master)-부(slave)** 관계를 설정하여 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식으로 이루어진다.

쓰기 연산은 주 데이터베이스 서버에서만 지원하고, 부 데이터베이스 서버는 주 데이터베이스 서버로부터 사본을 전달받으며 읽기 연산만을 지원한다.

보통 읽기 연산이 쓰기 연산보다 훨씬 많이 발생하므로 부 데이터베이스 서버가 주 데이터베이스 서버보다 많다.

장점

- 성능 개선 : 읽기 연산이 부 데이터베이스 서버들로 분산되어 병렬로 처리되는 query가 많아진다.
- 안정성 : 자연 재해 등으로 데이터베이스 서버 중 일부가 파괴되어도 데이터를 보존할 수 있다.
- 가용성 : 하나의 데이터베이스 서버에 장애가 발생하더라도 다른 서버의 데이터를 이용해 계속 서비스할 수 있다.
    - `안정성`과 `가용성`의 차이
    <br/>
    
    | 구분 | 안정성 | 가용성 |
    | --- | --- | --- |
    | **목적** | 데이터를 안전하게 보존 | 서비스를 중단 없이 제공 |
    | **초점** | 데이터 손실 방지 | 장애 시에도 서비스 지속성 확보 |
    | **장애 상황** | 데이터 센터 전체 손실 대비 | 특정 서버 장애 대응 |

## 응답시간(latency) 개선

### 캐시(Cache)

캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고, 이후 동일한 요청이 보다 빨리 처리될 수 있도록 하는 저장소이다.

캐시 계층(cache tier)은 데이터가 잠시 보관되는 곳으로 데이터베이스보다 **훨씬 빠르다**. 별도의 캐시 계층을 두면 성능 개선, 데이터베이스의 부하 감소 및 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능하다.

다양한 캐시 전략이 존재하는데 캐시할 데이터 종류, 크기, 액세스 패턴에 맞게 선택하면 된다. 대표적인 전략으로는 읽기 주도형 캐시 전략(read-through caching strategy)이 있다.

- 캐시에 응답이 저장되어 있다면 해당 데이터를 클라이언트에게 바로 반환, 저장되어 있지 않다면 데이터베이스에서 데이터를 찾아 캐시에 저장한 뒤 클라이언트에게 반환한다.

사용 시 고려해야 할 사항

- 상황 : 데이터 갱신은 자주 일어나지 않지만 데이터 참조는 자주 일어나는 상황에서 유용하다.
- 데이터의 종류 : 영속적으로 보관하지 않을 데이터는 캐시에, 중요한 데이터는 지속적 저장소(persistent data store)에 저장해야 한다.
- 데이터의 만료(expire) : 적절한 만료 정책에 의해 캐시에서 삭제되어야 한다.
- 일관성(consistency) : 데이터 저장소의 원본과 캐시 내의 사본을 일관되게 유지해야 한다.
- 장애 대응 : 단일 장애 지점(Single Point of Failure, SPOF)를 피하기 위해 여러 지역에 걸쳐 캐시 서버를 분산시켜야 한다.
- 캐시 메모리 : 캐시의 성능 하락을 막기 위해 캐시 메모리를 과할당(overprovision)할 수 있다.
- 데이터 방출(eviction) 정책 : 캐시가 가득 찬 상태에서 추가로 데이터가 들어오는 경우 LRU(Least Recently Used), LFU(Least Frequently Used) 등의 정책으로 기존 데이터를 내보내야 한다.

### 콘텐츠 전송 네트워크(CDN)

CDN(Content Delivery Network)은 이미지, 비디오, CSS, JavaScript 파일 등의 **정적 콘텐츠**를 캐싱하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다. CDN을 이용하면 정적 콘텐츠는 더이상 웹 서버를 통해 서비스되지 않는다.

1. 사용자가 정적 콘텐츠에 접근한다.
2. 사용자에게 가장 가까운 CDN 서버에 해당 콘텐츠가 없는 경우, CDN 서버는 원본 서버에 요청하여 콘텐츠를 가져온다.
3. CDN 서버는 콘텐츠를 캐시하고 사용자에게 반환한다.

사용 시 고려해야 할 사항

- 비용 : CDN을 거치는 데이터 전송 양에 따라 요금을 내므로, 자주 사용하는 콘텐츠만을 캐싱하는 것이 좋다
- 적절한 만료 시한 설정 : 시의성이 중요한(time-sensitive) 콘텐츠의 경우 적절한 만료 시점을 정해야 한다.
- CDN 장애 대처 방안 : CDN 자체가 다운된다면 웹사이트는 해당 문제를 감지하고, 원본 서버로부터 직접 콘텐츠를 가져와야 할 수도 있다.
- 콘텐츠 무효화 방법 : 아직 만료되지 않은 콘텐츠여도 CDN 서비스에서 제공하는 API나 오브젝트 버저닝(object versioning)을 이용하여 CDN에서 제거할 수 있다.

## 무상태(stateless) 웹 계층

웹 계층의 수평적 규모 확장 방안이다.

### 상태 정보 의존적인 아키텍처

서버는 각 클라이언트의 상태 정보를 유지하여 요청들 사이에 공유되도록 하는데, 이때 문제는 같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다는 것이다. 이를 지원하기 위해서는 로드밸런서에 부담이 발생할 뿐 아니라 서버를 추가/제거하는 것이 까다로워지며 나아가 장애 처리도 복잡해진다.

### 무상태 아키텍처

무상태 아키텍처에서 웹 서버는 상태 정보가 필요한 경우 **공유 저장소(shared storage)**로부터 데이터를 가져온다. 즉 상태 정보는 웹 서버로부터 물리적으로 분리되어 있으므로, 사용자로부터의 HTTP 요청은 어떤 웹 서버로도 전달될 수 있다.

상태 정보가 웹 서버들로부터 제거되었으므로, 트래픽 양에 따라 웹 서버를 자동으로 추가하거나 삭제하는 **자동 규모 확장(autoscaling)**이 가능하다.

## 데이터 센터

데이터 계층의 수평적 규모 확장 방안이다.

여러 데이터 센터들 중 하나에 심각한 장애가 발생하면 모든 트래픽은 장애가 없는 데이터 센터로 전송된다. 이 상황에서 해결해야 하는 기술적 문제는 다음과 같다.

- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내야 한다. 지리적 라우팅(geoDNS-routing 또는 geo-routing)을 통해 데이터 센터가 여러 개일 때 사용자는 **가장 가까운** 데이터 센터로 안내된다.
- 데이터 동기화(synchronization) : 데이터 센터마다 별도의 데이터베이스를 사용한다면, 장애가 자동으로 복구되어(failover) 트래픽이 우회된다고 해도 찾는 데이터가 없을 수 있다. 이를 막기 위해 보통 데이터를 여러 데이터 센터에 걸쳐 다중화하는 방식을 사용한다.
- 테스트와 배포(deployment) : 웹 사이트 또는 애플리케이션을 여러 위치에서 테스트해봐야 한다.

## 메시지 큐

시스템의 분리된 컴포넌트를 독립적으로 확장하기 위해 사용되는 방안이다.

메시지 큐는 메시지의 **무손실**(durability)을 보장하는 **비동기** 통신(asynchronous communication) 컴포넌트로, 메시지의 **버퍼** 역할을 한다.

메시지 큐를 이용하면 서비스 또는 서버 간 결합이 느슨해져, **규모 확장성**이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다.

## 로그, 메트릭 그리고 자동화

대규모 시스템을 운영할 때에 필요한 도구들이다.

로그 : 로그를 단일 서비스로 모아주는 도구를 통해 로그를 더 편리하게 조회/검색할 수 있다.

메트릭 : 메트릭을 통해 사업 현황 및 시스템의 현재 상태에 대해 파악할 수 있다. 특히 유용한 것으로 호스트 단위 메트릭, 종합 메트릭, 핵심 비즈니스 메트릭이 있다.

자동화 : **지속적 통합(continuous integration)**을 도와주는 도구를 통해 빌드, 테스트, 배포 등을 자동화하여 개발 생산성을 향상시킬 수 있다.

## 데이터베이스의 규모 확장

### 수직적 규모 확장

서버에 고사양 자원(CPU, RAM 등)을 추가함으로써 서버의 성능을 향상시키는 것 (스케일 업)

데이터베이스 서버의 하드웨어 상의 한계 및 **SPOF**로 인한 위험성, 비용 증가 등의 문제가 발생한다.

### 수평적 규모 확장

서버를 추가함으로써 서버의 성능을 개선하는 것(스케일 아웃)으로, 데이터베이스의 수평적 확장은 샤딩이라고도 부른다.

**샤딩(sharding)**은 대규모 데이터베이스를 샤드(shard)라고 부르는 작은 단위로 분할하는 기술을 말한다. 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 **중복이 없다**.

샤딩 전략 구현 시에 가장 중요한 것은, 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼으로 구성되는 **샤딩 키(sharding key)**를 정하는 기준이다. 이때 데이터를 고르게 분할할 수 있도록 하는 것이 가장 중요하다.

샤딩 도입 시 다음과 같은 문제가 발생하기도 한다.

- 데이터의 재샤딩(resharding) : 데이터가 너무 많아져서 하나의 샤드로 감당하기 어려운 현상, 또는 샤드 간 데이터 분포가 불균등하여 샤드들의 공간 소모 속도가 상이한 현상을 샤드 소진(shard exhaustion)이라고 한다. 샤드 소진이 발생하면 샤드 키를 계산하는 함수를 변경하고 데이터를 재배치하는 재샤딩이 필요하다.
- 유명인사(celebrity) 문제 : 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제다.
- 조인과 비정규화(join and de-normalization) : 여러 샤드에 걸친 데이터를 조인하기 힘들어질 수 있는데, 데이터베이스를 비정규화하여 하나의 테이블에서 질의가 수행되게 함으로써 해결할 수 있다.
